console.log('๐ ะกะขะะะข ะกะะะะะะ - ะะะะะฏ ะะะะกะะฏ ะก ะะะะะะะกะขะะะะ ะฎKASSA!');
console.log('โฐ ะัะตะผั ะทะฐะฟััะบะฐ:', new Date().toISOString());

require('dotenv').config();
const express = require('express');
const path = require('path');
const axios = require('axios');
const crypto = require('crypto');
// ะะผะฟะพัั ะฎKassa
let YooCheckout;
try {
    console.log('๐ง ะะพะฟััะบะฐ ะธะผะฟะพััะฐ ะฎKassa...');
    const yooModule = require('@a2seven/yoo-checkout');
    YooCheckout = yooModule.YooCheckout;
    console.log('โ ะฎKassa ะผะพะดัะปั ะธะผะฟะพััะธัะพะฒะฐะฝ ััะฟะตัะฝะพ');
    console.log('๐ฆ YooCheckout:', typeof YooCheckout);
} catch (error) {
    console.error('โ ะัะธะฑะบะฐ ะธะผะฟะพััะฐ ะฎKassa:', error.message);
    console.error('โ Stack:', error.stack);
    YooCheckout = null;
}
const config = require('./config');
const { initializeDatabase, OrdersDB, PurchaseHistoryDB, AdminProductsDB } = require('./database');

const app = express();
const PORT = config.PORT;
const TELEGRAM_BOT_TOKEN = config.TELEGRAM_BOT_TOKEN;
const TELEGRAM_ADMIN_CHAT_ID = config.TELEGRAM_ADMIN_CHAT_ID;

// ๐ณ ะะะะฆะะะะะะะฆะะฏ YOOKASSA
console.log('๐ ะะะะกะะฏ 2.0 - ะะะะะฃะะะขะะะฌะะะ ะะะะะะะะะะ RAILWAY!');
console.log('โฐ ะัะตะผั ัะฑะพัะบะธ:', new Date().toISOString());
console.log('๐ง ะะฝะธัะธะฐะปะธะทะฐัะธั ะฎKassa...');
console.log('๐ Shop ID:', config.YOOKASSA_SHOP_ID ? `${config.YOOKASSA_SHOP_ID.substring(0, 6)}***` : 'ะะ ะฃะกะขะะะะะะะ');
console.log('๐ Secret Key:', config.YOOKASSA_SECRET_KEY ? `${config.YOOKASSA_SECRET_KEY.substring(0, 6)}***` : 'ะะ ะฃะกะขะะะะะะะ');
console.log('๐ Shop ID ะฟะพะปะฝัะน:', config.YOOKASSA_SHOP_ID);
console.log('๐ Secret Key ะฟะพะปะฝัะน:', config.YOOKASSA_SECRET_KEY);

let checkout = null;
try {
    if (!YooCheckout) {
        throw new Error('YooCheckout ะบะปะฐัั ะฝะต ะฝะฐะนะดะตะฝ - ะฟะฐะบะตั ะฝะต ัััะฐะฝะพะฒะปะตะฝ');
    }
    
    if (!config.YOOKASSA_SHOP_ID || !config.YOOKASSA_SECRET_KEY) {
        throw new Error('ะะต ะฝะฐัััะพะตะฝั ะบะปััะธ ะฎKassa');
    }
    
    console.log('๐ง ะกะพะทะดะฐะตะผ ัะบะทะตะผะฟะปัั YooCheckout...');
    checkout = new YooCheckout({
        shopId: config.YOOKASSA_SHOP_ID,
        secretKey: config.YOOKASSA_SECRET_KEY
    });
    
    console.log('โ ะฎKassa ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฐ ััะฟะตัะฝะพ');
    console.log('๐ฆ ะะตััะธั ะฟะฐะบะตัะฐ: @a2seven/yoo-checkout@1.2.0');
    console.log('๐ Shop ID:', config.YOOKASSA_SHOP_ID);
    console.log('๐ Secret Key:', config.YOOKASSA_SECRET_KEY ? `${config.YOOKASSA_SECRET_KEY.substring(0, 6)}***` : 'ะะ ะฃะกะขะะะะะะะ');
} catch (error) {
    console.error('โ ะัะธะฑะบะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฎKassa:', error.message);
    console.log('โ๏ธ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟัััะธััั ะฑะตะท ะฎKassa');
    console.log('๐ง ะัะพะฒะตัััะต: 1) ะฃััะฐะฝะพะฒะปะตะฝ ะปะธ ะฟะฐะบะตั 2) ะะฐัััะพะตะฝั ะปะธ ะบะปััะธ');
}

// ะฅัะฐะฝะธะปะธัะต ะทะฐะบะฐะทะพะฒ (ะฒ ะฟัะพะดะฐะบัะตะฝะต ะทะฐะผะตะฝะธัั ะฝะฐ ะฑะฐะทั ะดะฐะฝะฝัั)
let orders = new Map();
let orderCounter = 0; // ะะฐัะธะฝะฐะตะผ ั 0 ะดะปั ะฝะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั

// ๐ฅ ะขะะะะะะซ ะะะฏ ะะะขะะะะขะะงะะกะะะ ะะขะะะะซ ะะะะะะะ (30 ะผะธะฝัั)
let orderTimers = new Map();

// ๐ง ะฅะะะะะะะฉะ ะขะะะะะะ ะะะฏ ะะะะะ ะะะะะะ
let adminProducts = new Map();

app.use(express.json());

// ๐ง CORS ะดะปั ะฐะดะผะธะฝ ะฟะฐะฝะตะปะธ
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, PATCH, DELETE, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Admin-Password');
    
    if (req.method === 'OPTIONS') {
        res.sendStatus(200);
    } else {
        next();
    }
});

// ๐๏ธ ะะะะะซะ ะะะขะะะะ ะขะะะะะะ (ะฒัะต 49 ัะพะฒะฐัะพะฒ ะธะท 8 ะบะฐัะตะณะพัะธะน)
async function loadFullProductCatalog() {
    return {
        'kolbasy': [
            {
                id: 'chorizo-70',
                name: 'ะะพะปะฑะฐัะฐ ะธะท ัััะพะฒัะปะตะฝะฐั ะพะปะตะฝะธะฝั "ะงะพัะธะทะพ"',
                price: 395,
                unit: '/70 ะณั.',
                maxQty: 20,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/chorizo-70.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ัะผะตัั 5 ะฟะตััะตะฒ, ะฟะฐะฟัะธะบะฐ ะบะพะฟัะตะฝะฐั, ะบะฐัะดะฐะผะพะฝ, ะฟะตัะตั ัะตัะฝัะน',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ',
                calories: '510 ะบะบะฐะป/2140 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'trufel-70',
                name: 'ะะพะปะฑะฐัะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ะพะปะตะฝะธะฝั "ะก ะขัััะตะปะตะผ"',
                price: 411,
                unit: '/70 ะณั.',
                maxQty: 20,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/trufel-70.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ัะฟะตัะธะธ, ะฟะตัะตั, ััััะตะปั ัะตัะฝัะน 0,02%, ะผััะบะฐัะฝัะน ะพัะตั',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ',
                calories: '510 ะบะบะฐะป/2140 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'kedr-70',
                name: 'ะะพะปะฑะฐัะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ะพะปะตะฝะธะฝั "ะกะตะฒะตัะฝะฐั ั ะบะตะดัะพะฒัะผ ะพัะตัะพะผ"',
                price: 405,
                unit: '/70 ะณั.',
                maxQty: 20,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/kedr-70.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ะพัะตั ะบะตะดัะพะฒัะน, ัะผะตัั ัะฟะตัะธะน ะธ ะฟััะฝะพััะตะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ, ัะณะปะตะฒะพะดั - 8 ะณ',
                calories: '540 ะบะบะฐะป/2266 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'osobaya-70',
                name: 'ะะพะปะฑะฐัะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ะพะปะตะฝะธะฝั "ะัะพะฑะฐั"',
                price: 390,
                unit: '/70 ะณั.',
                maxQty: 20,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/osobaya-70.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ัะฐัะฐั, ัะฟะตัะธะธ, ัะตัะฝะพะบ ะผะพะปะพััะน, ะผััะบะฐัะฝัะน ะพัะตั, ะฟะตัะตั, ะฐะฝัะธะพะบะธัะปะธัะตะปั (ะฐัะบะพัะฑะธะฝะพะฒะฐั ะบะธัะปะพัะฐ), ััะฐััะพะฒัะต ะบัะปััััั (ะผะพะปะพัะฝะพะบะธัะปัะต ะผะธะบัะพะพัะณะฐะฝะธะทะผั)',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ',
                calories: '510 ะบะบะฐะป/2140 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'chorizo-170',
                name: 'ะะพะปะฑะฐัะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ะพะปะตะฝะธะฝั "ะงะพัะธะทะพ"',
                price: 860,
                unit: '/170 ะณั.',
                maxQty: 15,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/chorizo-170.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ัะผะตัั 5 ะฟะตััะตะฒ, ะฟะฐะฟัะธะบะฐ ะบะพะฟัะตะฝะฐั, ะบะฐัะดะฐะผะพะฝ, ะฟะตัะตั ัะตัะฝัะน',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ',
                calories: '510 ะบะบะฐะป/2140 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'trufel-200',
                name: 'ะะพะปะฑะฐัะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ะพะปะตะฝะธะฝั "ะก ะขัััะตะปะตะผ"',
                price: 980,
                unit: '/200 ะณั.',
                maxQty: 12,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/trufel-200.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ัะฟะตัะธะธ, ะฟะตัะตั, ััััะตะปั ัะตัะฝัะน 0,02%, ะผััะบะฐัะฝัะน ะพัะตั',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ',
                calories: '510 ะบะบะฐะป/2140 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'osobaya-170',
                name: 'ะะพะปะฑะฐัะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ะพะปะตะฝะธะฝั "ะัะพะฑะฐั"',
                price: 885,
                unit: '/170 ะณั.',
                maxQty: 12,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/osobaya-170.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ัะฐัะฐั, ัะฟะตัะธะธ, ัะตัะฝะพะบ ะผะพะปะพััะน, ะผััะบะฐัะฝัะน ะพัะตั, ะฟะตัะตั',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ',
                calories: '510 ะบะบะฐะป/2140 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'kedr-160',
                name: 'ะะพะปะฑะฐัะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ะพะปะตะฝะธะฝั "ะกะตะฒะตัะฝะฐั ั ะบะตะดัะพะฒัะผ ะพัะตัะพะผ"',
                price: 910,
                unit: '/160 ะณั.',
                maxQty: 10,
                image: '๐ญ',
                imageUrl: 'images/products/kolbasy/kedr-160.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะถะธั ะณะพะฒัะถะธะน, ะพัะตั ะบะตะดัะพะฒัะน, ัะผะตัั ัะฟะตัะธะน ะธ ะฟััะฝะพััะตะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะฑะตะปะพะบ - 15 ะณ, ะถะธั - 20 ะณ, ัะณะปะตะฒะพะดั - 8 ะณ',
                calories: '540 ะบะบะฐะป/2266 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            }
        ],
        'pashtet': [
            {
                id: 'riyet-olene-griby',
                name: 'ะะธะนะตั ะธะท ะพะปะตะฝะธะฝั ั ะฑะตะปัะผะธ ะณัะธะฑะฐะผะธ ะธ ััััะตะปะตะผ',
                price: 378,
                unit: '/85 ะณั.',
                maxQty: 15,
                image: '๐ฅซ',
                imageUrl: 'images/products/pashtet/riyet-olene-griby.jpg',
                composition: 'ะผััะพ ัะตะฒะตัะฝะพะณะพ ะพะปะตะฝั, ะณัะธะฑั ะฑะตะปัะต, ััััะตะปั ัะตัะฝัะน 0,02%, ะถะธั ะพะปะตะฝะธะน, ะปัะบ ัะตะฟัะฐััะน',
                nutrition: 'ะฑะตะปะบะธ - 17,8 ะณ, ะถะธัั - 19,8 ะณ, ัะณะปะตะฒะพะดั - 2,6 ะณ',
                calories: '259,8 ะบะบะฐะป/1087 ะบะะถ',
                storage: '90 ัััะพะบ',
                available: true
            },
            {
                id: 'riyet-serdtse',
                name: 'ะะธะนะตั ะธะท ัะตัะดัะฐ ะพะปะตะฝั ั ัะฐะผะฟะธะฝัะพะฝะฐะผะธ, ัะณะพะดะฐะผะธ, ะผะพะถะถะตะฒะตะปัะฝะธะบะฐ ะธ ัะพะทะผะฐัะธะฝะพะผ',
                price: 360,
                unit: '/85 ะณั.',
                maxQty: 15,
                image: '๐ฅซ',
                imageUrl: 'images/products/pashtet/riyet-serdtse.jpg',
                composition: 'ะผััะพ ัะตะฒะตัะฝะพะณะพ ะพะปะตะฝั, ะผะพัะบะพะฒั, ะปัะบ, ะฒะธะฝะพ ะฑะตะปะพะต ัััะพะต, ัะพะปั ะผะพััะบะฐั, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะผะฐัะปะพ ัะปะธะฒะพัะฝะพะต, ัะพะปั, ัะณะพะดั ะผะพะถะถะตะฒะตะปัะฝะธะบะฐ, ะฟะตัะตั',
                nutrition: 'ะฑะตะปะบะธ - 12 ะณ, ะถะธัั - 10 ะณ, ัะณะปะตะฒะพะดั - 9 ะณ',
                calories: '182 ะบะบะฐะป/762 ะบะะถ',
                storage: '90 ัััะพะบ',
                available: true
            },
            {
                id: 'riyet-utka',
                name: 'ะะธะนะตั ะธะท ะฟะพะปััะฝะพะน ััะบะธ ั ััััะตะปะตะผ',
                price: 378,
                unit: '/85 ะณั.',
                maxQty: 15,
                image: '๐ฅซ',
                imageUrl: 'images/products/pashtet/riyet-utka.jpg',
                composition: 'ะผััะพ ััะบะธ, ะฑะตะปัะต ะณัะธะฑั, ะฒะธะฝะพ ะฑะตะปะพะต ัััะพะต, ััะธะฝัะน ะถะธั, ััััะตะปั ัะตัะฝัะน 0,02%, ะปัะบ, ัะพะปั ะผะพััะบะฐั, ัะฟะตัะธะธ',
                nutrition: 'ะฑะตะปะบะธ - 13,3 ะณ, ะถะธัั - 45,9 ะณ, ัะณะปะตะฒะพะดั - 2,3 ะณ',
                calories: '496 ะบะบะฐะป/2077 ะบะะถ',
                storage: '90 ัััะพะบ',
                available: true
            },
            {
                id: 'riyet-yagnenok',
                name: 'ะะธะนะตั ะธะท ัะณะฝะตะฝะบะฐ',
                price: 365,
                unit: '/85 ะณั.',
                maxQty: 15,
                image: '๐ฅซ',
                imageUrl: 'images/products/pashtet/riyet-yagnenok.jpg',
                composition: 'ะผััะพ ัะณะฝะตะฝะบะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะปัะบ, ัะพะปั ะผะพััะบะฐั, ัะฟะตัะธะธ',
                nutrition: 'ะฑะตะปะบะธ - 15,7 ะณ, ะถะธัั - 15,4 ะณ, ัะณะปะตะฒะพะดั - 5,5 ะณ',
                calories: '223,4 ะบะบะฐะป/935 ะบะะถ',
                storage: '90 ัััะพะบ',
                available: true
            }
        ],
        'delikatesy': [
            {
                id: 'hamon-utka',
                name: 'ะฅะฐะผะพะฝ ะธะท ััะบะธ ัััะพะฒัะปะตะฝัะน',
                price: 560,
                unit: '/70 ะณั.',
                maxQty: 12,
                image: '๐ฅฉ',
                imageUrl: 'images/products/delikatesy/hamon-utka.jpg',
                composition: 'ัะธะปะต ััะธะฝะพะน ะณััะดะบะธ ะฟัะตะผะธัะผ, ัะพะปั, ัะฟะตัะธะธ',
                nutrition: 'ะฑะตะปะบะธ - 18,9 ะณ, ะถะธัั - 9 ะณ, ัะณะปะตะฒะพะดั - 1,9 ะณ',
                calories: '172 ะบะบะฐะป/720,1 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'karpachcho-olene',
                name: 'ะะฐัะฟะฐััะพ ะธะท ะพะปะตะฝะธะฝั ะฒัััะธะน ัะพัั',
                price: 495,
                unit: '/70 ะณั.',
                maxQty: 12,
                image: '๐ฅฉ',
                imageUrl: 'images/products/delikatesy/karpachcho-olene.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ ะฒัััะธะน ัะพัั, ัะฟะตัะธะธ, ัะพะปั',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 6 ะณ',
                calories: '160 ะบะบะฐะป/620 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'sneki-okorok',
                name: 'ะกะฝะตะบะธ ะธะท ะพะบะพัะพะบะฐ ะพะปะตะฝั ัััะพะฒัะปะตะฝัะต "ะขะฐัะถะฝัะต ั ะดัะผะบะพะผ"',
                price: 170,
                unit: '/30 ะณั.',
                maxQty: 12,
                image: '๐ฅฉ',
                imageUrl: 'images/products/delikatesy/sneki-okorok.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ 1 ัะพัั, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, BBQ ะฟะฐะฟัะธะบะฐ, ะผััะบะฐัะฝัะน ะพัะตั',
                nutrition: 'ะฑะตะปะบะธ - 20 ะณ, ะถะธัั - 6 ะณ',
                calories: '180 ะบะบะฐะป/610 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'filey-olene',
                name: 'ะคะธะปะตะน ะพะปะตะฝั ัััะพะฒัะปะตะฝัะน',
                price: 490,
                unit: '/70 ะณั.',
                maxQty: 12,
                image: '๐ฅฉ',
                imageUrl: 'images/products/delikatesy/filey-olene.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ัะฐัะฐั, ัะบัััะฐะบัั ะฟััะฝะพััะตะน (ัะตัะฝัะน ะฟะตัะตั, ะบะพัะธะฐะฝะดั), ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะะตะปะบะธ - 20,0 ะณ, ะถะธัั - 10,0 ะณ, ัะณะปะตะฒะพะดั - 1,5 ะณ',
                calories: '260 ะบะบะฐะป/1090 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'pastila-filey',
                name: 'ะะฐััะธะปะฐ ัััะพะฒัะปะตะฝะฐั ะธะท ัะธะปะตั ะพะปะตะฝั',
                price: 250,
                unit: '/50 ะณั.',
                maxQty: 15,
                image: '๐ฅฉ',
                imageUrl: 'images/products/delikatesy/pastila-filey.jpg',
                composition: 'ะฒััะตะทะบะฐ ะพะปะตะฝั ะฒัััะธะน ัะพัั, ัะฐัะฐั, ัะพะตะฒัะน ัะพัั, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ะฟะฐะฟัะธะบะฐ BBQ, ัะผะตัั ัะฟะตัะธะน, ะพััััะน ะบะฐะนะตะฝัะบะธะน ะฟะตัะตั, ะฝะธััะธัะฝะพ-ะฟะพัะพะปะพัะฝะฐั ัะผะตัั',
                nutrition: 'ะฑะตะปะบะธ - 25 ะณ, ะถะธัั โ 10 ะณ, ัะณะปะตะฒะพะดั - 3 ะณ',
                calories: '176 ะบะบะฐะป/736 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            },
            {
                id: 'chipsy-olene',
                name: 'ะงะธะฟัั ะธะท ะพะปะตะฝะธะฝั ัััะพะฒัะปะตะฝัะต',
                price: 230,
                unit: '/50 ะณั.',
                maxQty: 15,
                image: '๐ฅฉ',
                imageUrl: 'images/products/delikatesy/chipsy-olene.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ 1 ัะพัั, ัะพะปั, ัะพัั ะฒะพััะตััะตั, ัะฟะตัะธะธ, ัะฐัะฐั',
                nutrition: 'ะฑะตะปะบะธ - 18,0 ะณ, ะถะธัั - 7,0 ะณ, ัะณะปะตะฒะพะดั - 12,0 ะณ',
                calories: '140 ะบะบะฐะป/590 ะบะะถ',
                storage: '180 ัััะพะบ',
                available: true
            }
        ],
        'gotovye': [
            {
                id: 'koreyka-yagody',
                name: 'ะะพัะตะนะบะฐ ะพะปะตะฝั ะทะฐะฟะตััะฝะฝะฐั ะฒ ัะตะฒะตัะฝัั ัะณะพะดะฐั',
                price: 4880,
                unit: '/ะบะณ',
                maxQty: 5,
                image: '๐ฅ',
                imageUrl: 'images/products/gotovye/koreyka-yagody.jpg',
                composition: 'ะบะพัะตะนะบะฐ ะพะปะตะฝั ะฒัััะธะน ัะพัั, ะผะฐัะธะฝะฐะด ะธะท ะกะตะฒะตัะฝัั ัะณะพะด (ะฑัััะฝะธะบะฐ, ะผะพัะพัะบะฐ), ัะฟะตัะธะธ (ัะพะทะผะฐัะธะฝ, ัะผะตัั ะฟะตััะตะฒ), ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 11 ะณ',
                calories: '260 ะบะบะฐะป/1190 ะบะะถ',
                storage: '20 ัััะพะบ',
                available: true
            },
            {
                id: 'koreyka-bbq',
                name: 'ะะพัะตะนะบะฐ ะพะปะตะฝั ะทะฐะฟะตััะฝะฝะฐั "BBQ"',
                price: 4880,
                unit: '/ะบะณ',
                maxQty: 5,
                image: '๐ฅ',
                imageUrl: 'images/products/gotovye/koreyka-bbq.jpg',
                composition: 'ะบะพัะตะนะบะฐ ะพะปะตะฝั ะฒัััะธะน ัะพัั, ะะฐะฟัะธะบะฐ BBQ, ัะพัั ะฒะพััะตััะตั, ัะฟะตัะธะธ, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ะฝะธััะธัะฝะพ-ะฟะพัะพะปะพัะฝะฐั ัะผะตัั',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 11 ะณ',
                calories: '260 ะบะบะฐะป/1190 ะบะะถ',
                storage: '20 ัััะพะบ',
                available: true
            },
            {
                id: 'okorok-vino',
                name: 'ะะบะพัะพะบ ะพะปะตะฝั ัะพะผะปะตะฝัะน ั ะฒะธะฝะพะผ ะธ ะฟััะฝัะผะธ ััะฐะฒะฐะผะธ',
                price: 4480,
                unit: '/ะบะณ',
                maxQty: 5,
                image: '๐ฅ',
                imageUrl: 'images/products/gotovye/okorok-vino.jpg',
                composition: 'ะพะบะพัะพะบ ัะตะฒะตัะฝะพะณะพ ะพะปะตะฝั ะฒัััะธะน ัะพัั, ัะฐัะฐั, ัะพะตะฒัะน ัะพัั, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั, ัะธะผััะฝ, ัะพะทะผะฐัะธะฝ',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 6 ะณ',
                calories: '160 ะบะบะฐะป/620 ะบะะถ',
                storage: '20 ัััะพะบ',
                available: true
            },
            {
                id: 'okorok-trufel',
                name: 'ะะบะพัะพะบ ะพะปะตะฝั ัะพะผะปะตะฝัะน ั ััััะตะปะตะผ',
                price: 4600,
                unit: '/ะบะณ',
                maxQty: 5,
                image: '๐ฅ',
                imageUrl: 'images/products/gotovye/okorok-trufel.jpg',
                composition: 'ะพะบะพัะพะบ ัะตะฒะตัะฝะพะณะพ ะพะปะตะฝั ะฒัััะธะน ัะพัั, ะผะฐัะธะฝะฐะด (ัะพัั ะฒะพััะตััะตั, Guinness), ััััะตะปั ัะตัะฝัะน 0,02%, ัะผะตัั ัะฟะตัะธะน (ัะพะทะผะฐัะธะฝ, ะผััะบะฐัะฝัะน ะพัะตั, ะฐะฝะธั), ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 6 ะณ',
                calories: '160 ะบะบะฐะป/620 ะบะะถ',
                storage: '20 ัััะพะบ',
                available: true
            },
            {
                id: 'pastrami-trufel',
                name: 'ะะฐัััะฐะผะธ ะธะท ะพะบะพัะพะบะฐ ะพะปะตะฝั ั ััััะตะปะตะผ',
                price: 4630,
                unit: '/ะบะณ',
                maxQty: 5,
                image: '๐ฅ',
                imageUrl: 'images/products/gotovye/pastrami-trufel.jpg',
                composition: 'ะพะบะพัะพะบ ัะตะฒะตัะฝะพะณะพ ะพะปะตะฝั ะฒัััะธะน ัะพัั, ัะผะตัั ัะฟะตัะธะน (ัะธะผััะฝ, ัะพะทะผะฐัะธะฝ, ะบะพัะธะฐะฝะดั), ะผะฐัะธะฝะฐะด (ะฒะธะฝะพ ะบัะฐัะฝะพะต ัััะพะต, ะผัะด), ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 6 ะณ',
                calories: '160 ะบะบะฐะป/620 ะบะะถ',
                storage: '20 ัััะพะบ',
                available: true
            }
        ],
        'zamorozhennye': [
            {
                id: 'pelmeni-severnye',
                name: 'ะะตะปัะผะตะฝะธ ยซะกะตะฒะตัะฝัะตยป ั ััััะตะปะตะผ',
                price: 758,
                unit: '/500 ะณั.',
                maxQty: 8,
                image: 'โ๏ธ',
                imageUrl: 'images/products/zamorozhennye/pelmeni-severnye.jpg',
                composition: 'ัะฐัั - ะพะปะตะฝะธะฝะฐ, ัะพะปั, ะฟะตัะตั, ััััะตะปัะฝะพะต ะผะฐัะปะพ, ะขะตััะพ - ะผัะบะฐ ะฟัะตะฝะธัะฝะฐั ะฒ/ั, ะฒะพะดะฐ, ัะพะปั, ัะธัะฝัะน ะผะตะปะฐะฝะถ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต',
                nutrition: 'ะฑะตะปะบะธ - 16 ะณ, ะถะธัั - 12 ะณ, ัะณะปะตะฒะพะดั - 28 ะณ',
                calories: '220 ะบะบะฐะป/921 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pelmeni-taymyrskie',
                name: 'ะะตะปัะผะตะฝะธ ยซะขะฐะนะผัััะบะธะตยป',
                price: 758,
                unit: '/500 ะณั.',
                maxQty: 8,
                image: 'โ๏ธ',
                imageUrl: 'images/products/zamorozhennye/pelmeni-taymyrskie.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ะปัะบ, ะฒะพะดะฐ, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั, ะฟะตัะตั ัััะฝัะน ะผะพะปะพััะน. ะขะตััะพ โ ะผัะบะฐ ะฟัะตะฝะธัะฝะฐั ะฒ/ั, ะฒะพะดะฐ, ัะพะปั, ัะธัะฝัะน ะผะตะปะฐะฝะถ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 6 ะณ, ัะณะปะตะฒะพะดั - 28 ะณ',
                calories: '220 ะบะบะฐะป/921 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pelmeni-los-griby',
                name: 'ะะตะปัะผะตะฝะธ ั ะผััะพะผ ะปะพัั ะธ ะณัะธะฑะฐะผะธ',
                price: 780,
                unit: '/500 ะณั.',
                maxQty: 8,
                image: 'โ๏ธ',
                imageUrl: 'images/products/zamorozhennye/pelmeni-los-griby.jpg',
                composition: 'ะผััะพ ะปะพัั, ะณะพะฒัะถะธะน ะถะธั, ะปัะบ, ะฒะพะดะฐ, ะฟะตัะตั ัะตัะฝัะน ะผะพะปะพััะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั, ะณัะธะฑั ัะฐะผะฟะธะฝัะพะฝั. ะขะตััะพ: ะผัะบะฐ ะฒ/ั, ะฒะพะดะฐ, ัะธัะฝัะน ะผะตะปะฐะฝะถ, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต',
                nutrition: 'ะฑะตะปะบะธ - 16 ะณ, ะถะธัั - 12 ะณ, ัะณะปะตะฒะพะดั - 28 ะณ',
                calories: '220 ะบะบะฐะป/921 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pelmeni-chernye',
                name: 'ะะตะปัะผะตะฝะธ ัััะฝัะต ะธะท ะพะปะตะฝะธะฝั ั ััััะตะปะตะผ (ัััะฝะฐั ะปะตะฟะบะฐ)',
                price: 960,
                unit: '/500 ะณั.',
                maxQty: 6,
                image: 'โ๏ธ',
                imageUrl: 'images/products/zamorozhennye/pelmeni-chernye.jpg',
                composition: 'ัะฐัั - ะพะปะตะฝะธะฝะฐ, ะผะฐัะปะพ ัะปะธะฒะพัะฝะพะต, ะตะถะตะฒะธะบะฐ, ัะพะปั, ะผััะบะฐัะฝัะน ะพัะตั, ะพัะตะณะฐะฝะพ, ััััะตะปั -0,02%, ะขะตััะพ โ ะผัะบะฐ ะฟัะตะฝะธัะฝะฐั ะฒ/ั, ะฒะพะดะฐ, ัะพะปั, ัะธัะฝัะน ะผะตะปะฐะฝะถ, ัะตัะฝะธะปะฐ ะบะฐัะฐะบะฐัะธัั',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 6 ะณ, ัะณะปะตะฒะพะดั - 28 ะณ',
                calories: '220 ะบะบะฐะป/921 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            }
        ],
        'polufabrikaty': [
            {
                id: 'okorok-olene',
                name: 'ะะบะพัะพะบ ะพะปะตะฝั',
                price: 1970,
                unit: '/ะบะณ',
                maxQty: 6,
                image: '๐ฅ',
                imageUrl: 'images/products/polufabrikaty/okorok-olene.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ ะพะบะพัะพะบ ะฒัััะธะน ัะพัั',
                nutrition: 'ะฑะตะปะบะธ - 22 ะณ, ะถะธัั - 11 ะณ',
                calories: '260 ะบะบะฐะป/1190 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'vyrezka-olene',
                name: 'ะััะตะทะบะฐ ะพะปะตะฝั',
                price: 3160,
                unit: '/ะบะณ',
                maxQty: 4,
                image: '๐ฅ',
                imageUrl: 'images/products/polufabrikaty/vyrezka-olene.jpg',
                composition: 'ะฒััะตะทะบะฐ ะพะปะตะฝั ะฒัััะธะน ัะพัั',
                nutrition: 'ะะตะปะบะธ - 22 ะณ, ะะธัั - 11 ะณ',
                calories: '260 ะบะบะฐะป/1190 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'koreyka-kost',
                name: 'ะะพัะตะนะบะฐ ะพะปะตะฝั ะฝะฐ ะบะพััะธ',
                price: 3310,
                unit: '/ะบะณ',
                maxQty: 4,
                image: '๐ฅ',
                imageUrl: 'images/products/polufabrikaty/koreyka-kost.jpg',
                composition: 'ะบะพัะตะนะบะฐ ะพะปะตะฝั ะฒัััะธะน ัะพัั',
                nutrition: 'ะะตะปะบะธ - 22 ะณ, ะะธัั - 11 ะณ',
                calories: '260 ะบะบะฐะป/1190 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'kupaty-piknik',
                name: 'ะัะฟะฐัั "ะะธะบะฝะธะบ"',
                price: 1268,
                unit: '/ะบะณ',
                maxQty: 8,
                image: '๐ฅ',
                imageUrl: 'images/products/polufabrikaty/kupaty-piknik.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ัะฟะธะบ, ัะตัะฝะพะบ, ัะฐัะฐั, ัะบัััะฐะบัั ะฟััะฝะพััะตะน, ะบะพัะธะฐะฝะดั, ัะตัะฝัะน ะฟะตัะตั, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะฑะตะปะบะธ - 15,0 ะณ, ะถะธัั - 21,0 ะณ, ัะณะปะตะฒะพะดั - 1,5 ะณ',
                calories: '260 ะบะบะฐะป/1090 ะบะะถ',
                storage: '12 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'kupaty-tundra',
                name: 'ะัะฟะฐัั "ะขัะฝะดัะฐ"',
                price: 1268,
                unit: '/ะบะณ',
                maxQty: 8,
                image: '๐ฅ',
                imageUrl: 'images/products/polufabrikaty/kupaty-tundra.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ, ัะฟะธะบ, ะปัะบ, ัะฐัะฐั, ัะบัััะฐะบัั ะฟััะฝะพััะตะน, ัะพะปั ะฟะพะฒะฐัะตะฝะฝะฐั ะฟะธัะตะฒะฐั',
                nutrition: 'ะฑะตะปะบะธ - 15 ะณ, ะถะธัั - 21 ะณ, ัะณะปะตะฒะพะดั - 1 ะณ',
                calories: '250 ะบะบะฐะป/1050 ะบะะถ',
                storage: '12 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'kotleti-burger',
                name: 'ะะพัะปะตัั ะดะปั ะฑััะณะตัะฐ ะธะท ะผััะฐ ัะตะฒะตัะฝะพะณะพ ะพะปะตะฝั',
                price: 290,
                unit: '/300 ะณั. (2 ัััะบะธ)',
                maxQty: 10,
                image: '๐ฅ',
                imageUrl: 'images/products/polufabrikaty/kotleti-burger.jpg',
                composition: 'ะผััะพ ัะตะฒะตัะฝะพะณะพ ะพะปะตะฝั ััะฑะปะตะฝะฝะพะต, ะถะธั ะพะปะตะฝะธะน',
                nutrition: 'ะะตะปะบะธ - 17 ะณ, ะะธัั - 12 ะณ',
                calories: '270 ะบะบะฐะป/980 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'lopatka-olene',
                name: 'ะะพะฟะฐัะบะฐ ะพะปะตะฝั ะฑะตะท ะบะพััะธ',
                price: 1770,
                unit: '/ะบะณ',
                maxQty: 6,
                image: '๐ฅ',
                imageUrl: 'images/products/polufabrikaty/lopatka-olene.jpg',
                composition: 'ะพะปะตะฝะธะฝะฐ ะปะพะฟะฐัะพัะฝะฐั ัะฐััั ะฑะตะท ะบะพััะธ',
                nutrition: 'ะะตะปะบะธ - 19 ะณ, ะะธัั - 4 ะณ',
                calories: '112 ะบะบะฐะป/780 ะบะะถ',
                storage: '10 ะผะตัััะตะฒ',
                available: true
            }
        ],
        'pirogi-sytnye': [
            {
                id: 'pirog-ohotnichiy',
                name: 'ะะธัะพะณ ั ะพะปะตะฝะธะฝะพะน ะพัะพัะฝะธัะธะน',
                price: 880,
                unit: '/550 ะณั.',
                maxQty: 8,
                image: '๐ฅง',
                imageUrl: 'images/products/pirogi-sytnye/pirog-ohotnichiy.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะพะปะตะฝะธะฝะฐ ะฒ/ั, ัะพะผะฐัั ะฒัะปะตะฝัะต, ะผะฐัะปะพ ะพะปะธะฒะบะพะฒะพะต, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต, ะปัะบ ัะตะฟัะฐััะน, ะผะพัะบะพะฒั, ัะฟะตัะธะธ',
                nutrition: 'ะะตะปะบะธ 11.55 ะณ, ะะธัั 9.32 ะณ, ะฃะณะปะตะฒะพะดั 25.24 ะณ',
                calories: '232.8 ะบะบะฐะป/974.1 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-brusnika',
                name: 'ะะธัะพะณ ั ะพะปะตะฝะธะฝะพะน ะธ ะฑัััะฝะธะบะพะน',
                price: 880,
                unit: '/550 ะณั.',
                maxQty: 8,
                image: '๐ฅง',
                imageUrl: 'images/products/pirogi-sytnye/pirog-brusnika.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะพะปะตะฝะธะฝะฐ ะฒ/ั, ะฑัััะฝะธะบะฐ, ัะพะตะฒัะน ัะพัั, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะปัะบ ัะตะฟัะฐััะน, ัะฟะตัะธะธ',
                nutrition: 'ะะตะปะบะธ 14.02 ะณ, ะะธัั 9.12 ะณ, ะฃะณะปะตะฒะพะดั 23.42 ะณ',
                calories: '233.2 ะบะบะฐะป/917.6 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-griby-trufel',
                name: 'ะะธัะพะณ ั ะพะปะตะฝะธะฝะพะน, ะณัะธะฑะฐะผะธ ะธ ััััะตะปะตะผ',
                price: 880,
                unit: '/550 ะณั.',
                maxQty: 8,
                image: '๐ฅง',
                imageUrl: 'images/products/pirogi-sytnye/pirog-griby-trufel.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะพะปะตะฝะธะฝะฐ ะฒ/ั, ัะฐะผะฟะธะฝัะพะฝั ัะฒะตะถะธะต, ััััะตะปัะฝะฐั ะฟะฐััะฐ, ะผะฐัะปะพ ะพะปะธะฒะบะพะฒะพะต, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต, ะปัะบ ัะตะฟัะฐััะน, ัะฟะตัะธะธ',
                nutrition: 'ะะตะปะบะธ 13.02 ะณ, ะะธัั 9.31 ะณ, ะฃะณะปะตะฒะพะดั 25.42 ะณ',
                calories: '235.2 ะบะบะฐะป/921.4 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-gribnoy',
                name: 'ะะธัะพะณ ั ะณัะธะฑะฝัะผ ะถัะปัะตะฝะพะผ',
                price: 964,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ฅง',
                imageUrl: 'images/products/pirogi-sytnye/pirog-gribnoy.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ัะฐะผะฟะธะฝัะพะฝั ัะฒะตะถะธะต, ัะปะธะฒะบะธ ะฝะฐัััะฐะปัะฝัะต, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะปัะบ ัะตะฟัะฐััะน, ัะฟะตัะธะธ',
                nutrition: 'ะะตะปะบะธ 8.8 ะณ, ะะธัั 8.9 ะณ, ะฃะณะปะตะฒะพะดั 22.6 ะณ',
                calories: '241.2 ะบะบะฐะป/1009.68 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-kuritsa-griby',
                name: 'ะะธัะพะณ ั ะบััะธัะตะน ะธ ะณัะธะฑะฐะผะธ',
                price: 980,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ฅง',
                imageUrl: 'images/products/pirogi-sytnye/pirog-kuritsa-griby.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะบััะธะฝะพะต ัะธะปะต, ัะฐะผะฟะธะฝัะพะฝั ัะฒะตะถะธะต, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะปัะบ ัะตะฟัะฐััะน, ัะฟะตัะธะธ',
                nutrition: 'ะะตะปะบะธ 11.4 ะณ, ะะธัั 2.8 ะณ, ะฃะณะปะตะฒะพะดั 24.5 ะณ',
                calories: '255.3 ะบะบะฐะป/1085 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-kartofel-griby',
                name: 'ะะธัะพะณ ั ะบะฐััะพัะตะปะตะผ ะธ ะณัะธะฑะฐะผะธ',
                price: 922,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ฅง',
                imageUrl: 'images/products/pirogi-sytnye/pirog-kartofel-griby.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะบะฐััะพัะตะปั, ัะฐะผะฟะธะฝัะพะฝั ัะฒะตะถะธะต, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะปัะบ ัะตะฟัะฐััะน, ัะฟะตัะธะธ',
                nutrition: 'ะะตะปะบะธ 4.6 ะณ, ะะธัั 7.8 ะณ, ะฃะณะปะตะฒะพะดั 18.4 ะณ',
                calories: '154.8 ะบะบะฐะป/904 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-krasnaya-ryba',
                name: 'ะะธัะพะณ ั ะบัะฐัะฝะพะน ััะฑะพะน',
                price: 2460,
                unit: '/700 ะณั.',
                maxQty: 4,
                image: '๐ฅง',
                imageUrl: 'images/products/pirogi-sytnye/pirog-krasnaya-ryba.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ัะตะผะณะฐ (ะปะพัะพัั), ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะปัะบ ัะตะฟัะฐััะน, ัะฟะตัะธะธ',
                nutrition: 'ะะตะปะบะธ 14.9 ะณ, ะะธัั 13 ะณ, ะฃะณะปะตะฒะพะดั 24.6 ะณ',
                calories: '274.7 ะบะบะฐะป/1150.4 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            }
        ],
        'pirogi-sladkie': [
            {
                id: 'pirog-yabloko-smorodina',
                name: 'ะะธัะพะณ ั ัะฑะปะพะบะพะผ ะธ ัะตัะฝะพะน ัะผะพัะพะดะธะฝะพะน',
                price: 860,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-yabloko-smorodina.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ัะฑะปะพะบะธ ะฝะฐัััะฐะปัะฝัะต, ัะตัะฝะฐั ัะผะพัะพะดะธะฝะฐ ะฝะฐัััะฐะปัะฝะฐั, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 6.2 ะณ, ะะธัั 5.4 ะณ, ะฃะณะปะตะฒะพะดั 52.8 ะณ',
                calories: '251.4 ะบะบะฐะป/1163.3 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-vishnya',
                name: 'ะะธัะพะณ ั ะฒะธัะฝะตะน',
                price: 885,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-vishnya.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะฒะธัะฝั ะฝะฐัััะฐะปัะฝะฐั, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 6.5 ะณ, ะะธัั 5.8 ะณ, ะฃะณะปะตะฒะพะดั 52.4 ะณ',
                calories: '285.4 ะบะบะฐะป/1195.4 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-tvorog-klubnika',
                name: 'ะะธัะพะณ ั ัะฒะพัะพะณะพะผ ะธ ะบะปัะฑะฝะธะบะพะน',
                price: 874,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-tvorog-klubnika.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะบะปัะฑะฝะธะบะฐ ะฝะฐัััะฐะปัะฝะฐั, ะบัะตะผ ะฒะฐะฝะธะปัะฝะพ-ัะปะธะฒะพัะฝัะน ะทะฐะฒะฐัะฝะพะน, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 8.3 ะณ, ะะธัั 7.1 ะณ, ะฃะณะปะตะฒะพะดั 38.4 ะณ',
                calories: '285.6 ะบะบะฐะป/1049.2 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-tvorog-chernika',
                name: 'ะะธัะพะณ ั ัะฒะพัะพะณะพะผ ะธ ัะตัะฝะธะบะพะน',
                price: 878,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-tvorog-chernika.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ัะตัะฝะธะบะฐ ะฝะฐัััะฐะปัะฝะฐั, ะบัะตะผ ะฒะฐะฝะธะปัะฝะพ-ัะปะธะฒะพัะฝัะน ะทะฐะฒะฐัะฝะพะน ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 8.2 ะณ, ะะธัั 6.8 ะณ, ะฃะณะปะตะฒะพะดั 37.8 ะณ',
                calories: '258.6 ะบะบะฐะป/1049.2 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-tvorog-malina',
                name: 'ะะธัะพะณ ั ัะฒะพัะพะณะพะผ ะธ ะผะฐะปะธะฝะพะน',
                price: 880,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-tvorog-malina.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะผะฐะปะธะฝะฐ ะฝะฐัััะฐะปัะฝะฐั, ะบัะตะผ ะฒะฐะฝะธะปัะฝะพ-ัะปะธะฒะพัะฝัะน ะทะฐะฒะฐัะฝะพะน, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 8.4 ะณ, ะะธัั 7.2 ะณ, ะฃะณะปะตะฒะพะดั 38.1 ะณ',
                calories: '250.8 ะบะบะฐะป/1050 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-chernika',
                name: 'ะะธัะพะณ ั ัะตัะฝะธะบะพะน',
                price: 885,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-chernika.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ัะตัะฝะธะบะฐ ะฝะฐัััะฐะปัะฝะฐั, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 2.7 ะณ, ะะธัั 9.9 ะณ, ะฃะณะปะตะฒะพะดั 33.4 ะณ',
                calories: '245.8 ะบะบะฐะป/1026.18 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-yabloko-brusnika',
                name: 'ะะธัะพะณ ั ัะฑะปะพะบะพะผ ะธ ะฑัััะฝะธะบะพะน',
                price: 868,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-yabloko-brusnika.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ะฑัััะฝะธะบะฐ ะฝะฐัััะฐะปัะฝะฐั, ัะฑะปะพะบะธ ะฝะฐัััะฐะปัะฝัะต, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 3.5 ะณ, ะะธัั 4 ะณ, ะฃะณะปะตะฒะพะดั 35.7 ะณ',
                calories: '192.3 ะบะบะฐะป/805.25 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            },
            {
                id: 'pirog-yabloko',
                name: 'ะะธัะพะณ ั ัะฑะปะพะบะพะผ',
                price: 860,
                unit: '/700 ะณั.',
                maxQty: 6,
                image: '๐ง',
                imageUrl: 'images/products/pirogi-sladkie/pirog-yabloko.jpg',
                composition: 'ะผัะบะฐ ะฒ/ั, ัะฑะปะพะบะธ ะฝะฐัััะฐะปัะฝัะต, ัะพะปั, ัะฐัะฐั, ัะนัะพ, ะฒะพะดะฐ, ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต, ะดัะพะถะถะธ ัะปะตะฑะพะฟะตะบะฐัะฝัะต',
                nutrition: 'ะะตะปะบะธ 9.2 ะณ, ะะธัั 5.4 ะณ, ะฃะณะปะตะฒะพะดั 52.8 ะณ',
                calories: '258.4 ะบะบะฐะป/1184.3 ะบะะถ',
                storage: '6 ะผะตัััะตะฒ',
                available: true
            }
        ]
        // โ ะะะขะะะ! ะะกะ 8 ะะะขะะะะะะ, 49 ะขะะะะะะ!
    };
}

// ๐ณ ะคะฃะะะฆะะฏ ะกะะะะะะะฏ ะะะะขะะะ ะ YOOKASSA
async function createYooKassaPayment(orderId, amount, description, customerInfo) {
    try {
        console.log('๐ณ ะกะพะทะดะฐะตะผ ะฟะปะฐัะตะถ ะฎKassa ั ะฟะฐัะฐะผะตััะฐะผะธ:');
        console.log('   - ะกัะผะผะฐ:', amount.toFixed(2), 'RUB');
        console.log('   - ะะฟะธัะฐะฝะธะต:', description);
        console.log('   - ะะปะธะตะฝั:', customerInfo.customerName);
        
        const paymentData = {
            amount: {
                value: amount.toFixed(2),
                currency: 'RUB'
            },
            confirmation: {
                type: 'redirect',
                return_url: `https://tundra-miniapp-production.up.railway.app/payment/success?order=${orderId}`
            },
            capture: true,
            description: description,
            metadata: {
                orderId: orderId,
                customerName: customerInfo.customerName || 'ะะปะธะตะฝั',
                phone: customerInfo.phone || ''
            }
        };
        
        console.log('๐ณ ะัะฟัะฐะฒะปัะตะผ ะทะฐะฟัะพั ะฒ ะฎKassa...');
        const payment = await checkout.createPayment(paymentData, crypto.randomUUID());

        console.log(`โ ะะปะฐัะตะถ ัะพะทะดะฐะฝ ะฒ ะฎKassa: ${payment.id} ะฝะฐ ััะผะผั ${amount}โฝ`);
        console.log(`๐ URL ะฟะพะดัะฒะตัะถะดะตะฝะธั: ${payment.confirmation?.confirmation_url}`);
        return payment;
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ะฟะปะฐัะตะถะฐ ะฎKassa:');
        console.error('   - ะกะพะพะฑัะตะฝะธะต:', error.message);
        console.error('   - ะะพะด:', error.code);
        console.error('   - ะกัะฐััั:', error.status);
        console.error('   - ะะตัะฐะปะธ:', error.response?.data);
        throw error;
    }
}

// ะคัะฝะบัะธะธ ะดะปั ัะฐะฑะพัั ั ะทะฐะบะฐะทะฐะผะธ
async function createOrder(orderData) {
    orderCounter++;
    const orderId = orderCounter.toString();
    
    const order = {
        id: orderId,
        status: 'new', // new, accepted, preparing, delivering, completed, cancelled, expired
        paymentStatus: 'pending', // pending, paid, cancelled, expired
        createdAt: new Date(),
        updatedAt: new Date(),
        expiresAt: new Date(Date.now() + 30 * 60 * 1000), // 30 ะผะธะฝัั
        ...orderData
    };
    
    // ๐พ ะกะะฅะะะะฏะะ ะ ะะ ะ ะ ะะะะฏะขะฌ
    orders.set(orderId, order);
    
    // ะกะพััะฐะฝัะตะผ ะฒ ะฑะฐะทั ะดะฐะฝะฝัั
    try {
        const dbOrder = {
            orderId: order.id,
            userId: order.userId || order.telegramUserId || 'unknown',
            userName: order.customerName || 'ะะปะธะตะฝั',
            phone: order.phone || '',
            deliveryZone: order.deliveryZone || 'moscow',
            address: JSON.stringify(order.address || {}),
            items: JSON.stringify(order.cartItems || []),
            totalAmount: order.totals?.total || 0,
            status: order.status,
            paymentId: order.paymentId || null,
            paymentUrl: order.paymentUrl || null
        };
        
        await OrdersDB.create(dbOrder);
        console.log(`๐พ ะะฐะบะฐะท ${orderId} ัะพััะฐะฝะตะฝ ะฒ ะะ`);
    } catch (error) {
        console.error(`โ ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ะทะฐะบะฐะทะฐ ${orderId} ะฒ ะะ:`, error);
    }
    
    // ๐ฅ ะะะะฃะกะะะะ ะขะะะะะ ะะะขะะะขะะะะซ ะะ 30 ะะะะฃะข
    const timer = setTimeout(() => {
        autoExpireOrder(orderId);
    }, 30 * 60 * 1000); // 30 ะผะธะฝัั
    
    orderTimers.set(orderId, timer);
    
    console.log(`๐ฅ ะะฐะบะฐะท ${orderId} ัะพะทะดะฐะฝ. ะะฒัะพะพัะผะตะฝะฐ ัะตัะตะท 30 ะผะธะฝัั.`);
    
    return order;
}

function updateOrderStatus(orderId, newStatus) {
    const order = orders.get(orderId);
    if (order) {
        order.status = newStatus;
        order.updatedAt = new Date();
        orders.set(orderId, order);
        return order;
    }
    return null;
}

function getOrder(orderId) {
    return orders.get(orderId);
}

function getAllOrders() {
    return Array.from(orders.values()).sort((a, b) => b.createdAt - a.createdAt);
}

// ๐ฅ ะคะฃะะะฆะะฏ ะะะขะะะะขะะงะะกะะะ ะะขะะะะซ ะะะะะะ
function autoExpireOrder(orderId) {
    const order = orders.get(orderId);
    if (!order) {
        console.log(`โ๏ธ ะะฐะบะฐะท ${orderId} ะฝะต ะฝะฐะนะดะตะฝ ะดะปั ะฐะฒัะพะพัะผะตะฝั`);
        return;
    }
    
    // ะัะพะฒะตััะตะผ, ะฝะต ะฑัะป ะปะธ ะทะฐะบะฐะท ัะถะต ะพะฟะปะฐัะตะฝ
    if (order.paymentStatus === 'paid') {
        console.log(`โ ะะฐะบะฐะท ${orderId} ัะถะต ะพะฟะปะฐัะตะฝ, ะพัะผะตะฝะฐ ะพัะผะตะฝะตะฝะฐ`);
        clearOrderTimer(orderId);
        return;
    }
    
    // ะัะผะตะฝัะตะผ ะทะฐะบะฐะท
    order.status = 'expired';
    order.paymentStatus = 'expired';
    order.updatedAt = new Date();
    orders.set(orderId, order);
    
    // ะัะธัะฐะตะผ ัะฐะนะผะตั
    clearOrderTimer(orderId);
    
    console.log(`โฐ ะะฐะบะฐะท ${orderId} ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะผะตะฝะตะฝ (ะฒัะตะผั ะธััะตะบะปะพ)`);
}

// ะคัะฝะบัะธั ะพัะธััะบะธ ัะฐะนะผะตัะฐ ะทะฐะบะฐะทะฐ
function clearOrderTimer(orderId) {
    const timer = orderTimers.get(orderId);
    if (timer) {
        clearTimeout(timer);
        orderTimers.delete(orderId);
    }
}

// ะคัะฝะบัะธั ะพัะผะตะฝั ัะฐะนะผะตัะฐ ะฟัะธ ะพะฟะปะฐัะต
function cancelOrderTimer(orderId) {
    clearOrderTimer(orderId);
    console.log(`๐ฅ ะขะฐะนะผะตั ะทะฐะบะฐะทะฐ ${orderId} ะพัะผะตะฝะตะฝ (ะทะฐะบะฐะท ะพะฟะปะฐัะตะฝ)`);
}

// ะะฐัััะพะนะบะฐ ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ
const webRoot = path.join(__dirname, 'webapp');
app.use(express.static(webRoot));

// Health check endpoints
app.get('/health', (req, res) => {
    res.status(200).json({ 
        status: 'ok', 
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});

app.get('/ping', (req, res) => {
    res.status(200).send('pong');
});

// API ะดะปั ะทะฐะบะฐะทะพะฒ
app.post('/api/orders', async (req, res) => {
    console.log('๐ฅ ะะะะฃะงะะ ะะะะะะก ะะ ะกะะะะะะะ ะะะะะะ!');
    try {
        const orderData = req.body;
        console.log('๐ฆ ะะฐะฝะฝัะต ะทะฐะบะฐะทะฐ:', JSON.stringify(orderData, null, 2));
        
        // ะกะพะทะดะฐะตะผ ะทะฐะบะฐะท
        const order = await createOrder(orderData);
        console.log('โ ะะฐะบะฐะท ัะพะทะดะฐะฝ:', order.id);
        
        console.log(`๐ ะะฐะบะฐะท #${order.id} ัะพะทะดะฐะฝ, ัะพะทะดะฐะตะผ ะฟะปะฐัะตะถ ะฒ ะฎKassa...`);
        console.log(`๐ฐ ะกัะผะผะฐ ะทะฐะบะฐะทะฐ: ${order.totals?.total || 0}โฝ`);
        
        // ๐ณ ะกะะะะะะ ะะะะขะะ ะ YOOKASSA
        const totalAmount = order.totals?.total || 0;
        const description = `ะะฐะบะฐะท #${order.id} ะฒ Tundra Gourmet`;
        
        if (!config.YOOKASSA_SHOP_ID || !config.YOOKASSA_SECRET_KEY) {
            console.error('โ ะฎKassa ะบะปััะธ ะฝะต ะฝะฐัััะพะตะฝั!');
            console.error('โ Shop ID:', config.YOOKASSA_SHOP_ID);
            console.error('โ Secret Key:', config.YOOKASSA_SECRET_KEY ? 'ะะกะขะฌ' : 'ะะะข');
            throw new Error('ะฎKassa ะบะปััะธ ะฝะต ะฝะฐัััะพะตะฝั');
        }
        
        console.log('๐ณ ะฎKassa ะบะปััะธ ะฟัะพะฒะตัะตะฝั - ัะพะทะดะฐะตะผ ะฟะปะฐัะตะถ...');
        
        if (!checkout) {
            console.error('โ ะฎKassa ะฝะต ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฐ!');
            throw new Error('ะฎKassa ะฝะตะดะพัััะฟะฝะฐ');
        }
        
        const customerInfo = {
            customerName: `${order.address?.street || ''} ${order.address?.house || ''}`.trim() || 'ะะปะธะตะฝั',
            phone: order.phone || ''
        };
        
        // ะะพะฑะฐะฒะปัะตะผ customerName ะฒ ะทะฐะบะฐะท
        order.customerName = customerInfo.customerName;
        
        const payment = await createYooKassaPayment(order.id, totalAmount, description, customerInfo);
        
        // ะกะพััะฐะฝัะตะผ ID ะฟะปะฐัะตะถะฐ ะฒ ะทะฐะบะฐะทะต
        order.paymentId = payment.id;
        order.paymentUrl = payment.confirmation.confirmation_url;
        orders.set(order.id, order);
        
        // ะะฑะฝะพะฒะปัะตะผ ะฒ ะะ
        try {
            const updateData = {
                paymentId: order.paymentId,
                paymentUrl: order.paymentUrl,
                status: order.status
            };
            await OrdersDB.update(order.id, updateData);
        } catch (dbError) {
            console.error(`โ ะัะธะฑะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ะทะฐะบะฐะทะฐ ะฒ ะะ:`, dbError);
        }
        
        console.log(`โ ะะฐะบะฐะท #${order.id} ะธ ะฟะปะฐัะตะถ ัะพะทะดะฐะฝั ััะฟะตัะฝะพ`);
        console.log(`๐ Payment URL: ${payment.confirmation.confirmation_url}`);
        
        // ๐ฅ ะะ ะะขะะะะะะฏะะ ะฃะะะะะะะะะะ ะ ะะะะะ ะะะฃะะะฃ
        // ะฃะฒะตะดะพะผะปะตะฝะธะต ะฑัะดะตั ะพัะฟัะฐะฒะปะตะฝะพ ัะพะปัะบะพ ะฟะพัะปะต ััะฟะตัะฝะพะน ะพะฟะปะฐัั!
        
        const response = { 
            ok: true, 
            orderId: order.id,
            paymentUrl: payment.confirmation.confirmation_url,
            paymentId: payment.id,
            amount: totalAmount
        };
        
        console.log(`๐ค ะัะฟัะฐะฒะปัะตะผ ะพัะฒะตั ะบะปะธะตะฝัั:`, response);
        res.json(response);
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ ะทะฐะบะฐะทะฐ:', error);
        console.error('โ ะะตัะฐะปะธ ะพัะธะฑะบะธ:', error.stack);
        
        // ะัะปะธ ะพัะธะฑะบะฐ ะฎKassa, ะพัะฟัะฐะฒะธะผ ะทะฐะบะฐะท ะฑะตะท ะฟะปะฐัะตะถะฐ ะดะปั ัะตััะธัะพะฒะฐะฝะธั
        if (error.message.includes('ะฎKassa') || error.message.includes('shopId') || error.message.includes('secretKey') || error.message.includes('ะฝะตะดะพัััะฟะฝะฐ')) {
            console.log('โ๏ธ ะฎKassa ะฝะตะดะพัััะฟะฝะฐ, ะพัะฟัะฐะฒะปัะตะผ ะทะฐะบะฐะท ะฑะตะท ะฟะปะฐัะตะถะฐ (ะขะะกะขะะะซะ ะะะะะ)');
            
            // ะะตะฝะตัะธััะตะผ ัะตััะพะฒัั ัััะปะบั ะดะปั ะดะตะผะพะฝัััะฐัะธะธ
            const fallbackOrderId = order?.id || 'test_1';
            const testPaymentUrl = `https://yookassa.ru/demo/checkout?orderId=${fallbackOrderId}&amount=${order?.totals?.total || 0}`;
            
            res.json({ 
                ok: true, 
                orderId: fallbackOrderId,
                paymentUrl: testPaymentUrl,
                paymentId: 'test_payment_' + fallbackOrderId,
                amount: order?.totals?.total || 0,
                isTestMode: true,
                message: 'ะขะะกะขะะะซะ ะะะะะ: ะฎKassa ะฝะต ะฝะฐัััะพะตะฝะฐ'
            });
        } else {
            res.status(500).json({ ok: false, error: error.message });
        }
    }
});

// API ะดะปั ะฟะพะปััะตะฝะธั ะธััะพัะธะธ ะฟะพะบัะฟะพะบ ะบะปะธะตะฝัะฐ
app.get('/api/purchases/:userId', async (req, res) => {
    try {
        const { userId } = req.params;
        
        // ะะฐะณััะถะฐะตะผ ะธััะพัะธั ะฟะพะบัะฟะพะบ ะธะท ะะ
        const purchases = await PurchaseHistoryDB.getByUserId(userId);
        
        // ะะพะดััะธััะฒะฐะตะผ ััะฐัะธััะธะบั ะปะพัะปัะฝะพััะธ
        const totalPurchases = purchases.length;
        const totalSpent = purchases.reduce((sum, purchase) => sum + (purchase.totalAmount || 0), 0);
        
        // ๐ ะะะะะะ ะะะะขะซ ะะะฏะะฌะะะกะขะ ะะ ะฃะะะะะฏะ
        let loyaltyLevel, currentDiscount, nextLevelTarget, nextLevelProgress;
        
        if (totalSpent < 10000) {
            // ๐ 0โฝ - 9,999โฝ โ 0% ัะบะธะดะบะฐ
            loyaltyLevel = 0;
            currentDiscount = 0;
            nextLevelTarget = 10000;
            nextLevelProgress = (totalSpent / 10000) * 100;
        } else if (totalSpent < 25000) {
            // โญ 10,000โฝ - 24,999โฝ โ 3% ัะบะธะดะบะฐ
            loyaltyLevel = 1;
            currentDiscount = 3;
            nextLevelTarget = 25000;
            nextLevelProgress = ((totalSpent - 10000) / (25000 - 10000)) * 100;
        } else if (totalSpent < 50000) {
            // โญ 25,000โฝ - 49,999โฝ โ 5% ัะบะธะดะบะฐ
            loyaltyLevel = 2;
            currentDiscount = 5;
            nextLevelTarget = 50000;
            nextLevelProgress = ((totalSpent - 25000) / (50000 - 25000)) * 100;
        } else {
            // โญ 50,000โฝ+ โ 10% ัะบะธะดะบะฐ
            loyaltyLevel = 3;
            currentDiscount = 10;
            nextLevelTarget = null; // ะผะฐะบัะธะผะฐะปัะฝัะน ััะพะฒะตะฝั
            nextLevelProgress = 100;
        }
        
        res.json({
            ok: true,
            purchases,
            stats: {
                totalPurchases,
                totalSpent,
                loyaltyLevel,
                currentDiscount,
                nextLevelProgress: Math.round(nextLevelProgress),
                nextLevelTarget,
                levelName: loyaltyLevel === 0 ? "ะะพะฒะธัะพะบ" : 
                          loyaltyLevel === 1 ? "ะัะพะฝะทะฐ" :
                          loyaltyLevel === 2 ? "ะกะตัะตะฑัะพ" : "ะะพะปะพัะพ"
            }
        });
        
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ะธััะพัะธะธ ะฟะพะบัะฟะพะบ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// API ะดะปั ะฟะพะปััะตะฝะธั ะฒัะตั ะทะฐะบะฐะทะพะฒ
app.get('/api/orders', (req, res) => {
    try {
        const allOrders = getAllOrders();
        res.json({ ok: true, orders: allOrders });
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ะทะฐะบะฐะทะพะฒ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// API ะดะปั ะฟะพะปััะตะฝะธั ะบะพะฝะบัะตัะฝะพะณะพ ะทะฐะบะฐะทะฐ
app.get('/api/orders/:orderId', (req, res) => {
    try {
        const order = getOrder(req.params.orderId);
        if (order) {
            res.json({ ok: true, order });
        } else {
            res.status(404).json({ ok: false, error: 'ะะฐะบะฐะท ะฝะต ะฝะฐะนะดะตะฝ' });
        }
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ะทะฐะบะฐะทะฐ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// API ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ััะฐัััะฐ ะทะฐะบะฐะทะฐ
app.put('/api/orders/:orderId/status', (req, res) => {
    try {
        const { status } = req.body;
        const orderId = req.params.orderId;
        
        // ๐ฅ ะะะะะะะขะซะะะะ ะกะะะฆะะะะฌะะซะ ะกะขะะขะฃะกะซ
        if (status === 'cancelled' || status === 'expired') {
            // ะัะผะตะฝัะตะผ ัะฐะนะผะตั ะฟัะธ ัััะฝะพะน ะพัะผะตะฝะต ะธะปะธ ะธััะตัะตะฝะธะธ ะฒัะตะผะตะฝะธ
            clearOrderTimer(orderId);
        }
        
        const order = updateOrderStatus(orderId, status);
        
        if (order) {
            console.log(`๐ ะกัะฐััั ะทะฐะบะฐะทะฐ ${orderId} ะธะทะผะตะฝะตะฝ ะฝะฐ: ${status}`);
            res.json({ ok: true, order });
        } else {
            res.status(404).json({ ok: false, error: 'ะะฐะบะฐะท ะฝะต ะฝะฐะนะดะตะฝ' });
        }
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ััะฐัััะฐ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// Webhook ะดะปั Telegram
app.post('/api/telegram/webhook', (req, res) => {
    try {
        const { message, callback_query } = req.body;
        
        if (callback_query) {
            // ะะฑัะฐะฑะฐััะฒะฐะตะผ ะฝะฐะถะฐัะธะต ะฝะฐ inline-ะบะฝะพะฟะบั
            handleCallbackQuery(callback_query);
        } else if (message) {
            // ะะฑัะฐะฑะฐััะฒะฐะตะผ ะพะฑััะฝัะต ัะพะพะฑัะตะฝะธั
            console.log('ะะพะปััะตะฝะพ ัะพะพะฑัะตะฝะธะต:', message.text);
        }
        
        res.json({ ok: true });
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ Telegram webhook:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// ะคัะฝะบัะธั ะพะฑัะฐะฑะพัะบะธ callback query (ะฝะฐะถะฐัะธั ะฝะฐ ะบะฝะพะฟะบะธ)
async function handleCallbackQuery(callbackQuery) {
    try {
        const { data, message, from } = callbackQuery;
        const [action, orderId] = data.split('_');
        
        console.log(`ะะฑัะฐะฑะพัะบะฐ ะดะตะนััะฒะธั: ${action} ะดะปั ะทะฐะบะฐะทะฐ ${orderId}`);
        
        let order = getOrder(orderId);
        if (!order) {
            console.error(`ะะฐะบะฐะท ${orderId} ะฝะต ะฝะฐะนะดะตะฝ`);
            return;
        }
        
        let newStatus, statusText, statusEmoji;
        
        switch (action) {
            case 'accept':
                newStatus = 'accepted';
                statusText = 'ะัะธะฝัั';
                statusEmoji = '๐ก';
                break;
            case 'cancel':
                newStatus = 'cancelled';
                statusText = 'ะัะผะตะฝะตะฝ';
                statusEmoji = '๐ด';
                break;
            case 'preparing':
                newStatus = 'preparing';
                statusText = 'ะะพัะพะฒะธััั';
                statusEmoji = '๐ต';
                break;
            case 'delivering':
                newStatus = 'delivering';
                statusText = 'ะ ะดะพััะฐะฒะบะต';
                statusEmoji = '๐';
                break;
            case 'completed':
                newStatus = 'completed';
                statusText = 'ะะพััะฐะฒะปะตะฝ';
                statusEmoji = 'โ';
                break;
            default:
                console.error(`ะะตะธะทะฒะตััะฝะพะต ะดะตะนััะฒะธะต: ${action}`);
                return;
        }
        
        // ะะฑะฝะพะฒะปัะตะผ ััะฐััั ะทะฐะบะฐะทะฐ
        order = updateOrderStatus(orderId, newStatus);
        
        // ะะฑะฝะพะฒะปัะตะผ ัะพะพะฑัะตะฝะธะต ะฒ ะฐะดะผะธะฝ-ะณััะฟะฟะต
        await updateOrderMessage(message.chat.id, message.message_id, order, newStatus);
        
        // ะัะฟัะฐะฒะปัะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
        await axios.post(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/answerCallbackQuery`, {
            callback_query_id: callbackQuery.id,
            text: `ะกัะฐััั ะทะฐะบะฐะทะฐ #${orderId} ะธะทะผะตะฝะตะฝ ะฝะฐ "${statusText}"`
        });
        
        console.log(`ะกัะฐััั ะทะฐะบะฐะทะฐ ${orderId} ะธะทะผะตะฝะตะฝ ะฝะฐ ${newStatus}`);
        
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ callback query:', error);
    }
}

// ะคัะฝะบัะธั ะพะฑะฝะพะฒะปะตะฝะธั ัะพะพะฑัะตะฝะธั ั ะทะฐะบะฐะทะพะผ
async function updateOrderMessage(chatId, messageId, order, newStatus) {
    try {
        const statusEmojis = {
            'new': 'โณ',
            'accepted': '๐ก',
            'preparing': '๐ต',
            'delivering': '๐',
            'completed': 'โ',
            'cancelled': '๐ด'
        };
        
        const statusTexts = {
            'new': 'ะะพะฒัะน',
            'accepted': 'ะัะธะฝัั',
            'preparing': 'ะะพัะพะฒะธััั',
            'delivering': 'ะ ะดะพััะฐะฒะบะต',
            'completed': 'ะะพััะฐะฒะปะตะฝ',
            'cancelled': 'ะัะผะตะฝะตะฝ'
        };
        
        // ะคะพัะผะธััะตะผ ะพะฑะฝะพะฒะปะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต
        const message = `๐ ะะะะะ #${order.id} - ${statusEmojis[newStatus]} ${statusTexts[newStatus]}

๐ค ${order.customerName || 'ะะปะธะตะฝั'}
๐ ${order.address.street}, ${order.address.house}${order.address.apartment ? `, ะบะฒ.${order.address.apartment}` : ''} (${order.deliveryZone === 'moscow' ? 'ะะพัะบะฒะฐ' : 'ะะ'})
๐ฐ ${order.totals?.total || 0}โฝ
๐ฆ ${order.cartItems?.length || 0} ัะพะฒะฐัะพะฒ

๐ ะกะพััะฐะฒ ะทะฐะบะฐะทะฐ:
${order.cartItems.map(item => `โข ${item.name} x${item.quantity} - ${item.price * item.quantity}โฝ`).join('\n')}

๐ฑ ะขะตะปะตัะพะฝ: ${order.phone}
๐ฌ ะะพะผะผะตะฝัะฐัะธะน: ${order.comment || 'ะฝะตั'}

[๐ก ะัะธะฝััั] [๐ต ะะพัะพะฒะธััั] [๐ ะะพััะฐะฒะบะต] [โ ะะพััะฐะฒะปะตะฝ]`;

        // ะกะพะทะดะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะฝัะต ะบะฝะพะฟะบะธ ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ััะฐัััะฐ
        let inlineKeyboard;
        if (newStatus === 'new') {
            inlineKeyboard = {
                inline_keyboard: [
                    [
                        { text: '๐ก ะัะธะฝััั', callback_data: `accept_${order.id}` },
                        { text: '๐ด ะัะผะตะฝะธัั', callback_data: `cancel_${order.id}` }
                    ]
                ]
            };
        } else if (newStatus === 'accepted') {
            inlineKeyboard = {
                inline_keyboard: [
                    [
                        { text: '๐ต ะะพัะพะฒะธััั', callback_data: `preparing_${order.id}` },
                        { text: '๐ด ะัะผะตะฝะธัั', callback_data: `cancel_${order.id}` }
                    ]
                ]
            };
        } else if (newStatus === 'preparing') {
            inlineKeyboard = {
                inline_keyboard: [
                    [
                        { text: '๐ ะ ะดะพััะฐะฒะบั', callback_data: `delivering_${order.id}` }
                    ]
                ]
            };
        } else if (newStatus === 'delivering') {
            inlineKeyboard = {
                inline_keyboard: [
                    [
                        { text: 'โ ะะพััะฐะฒะปะตะฝ', callback_data: `completed_${order.id}` }
                    ]
                ]
            };
        } else {
            // ะะปั ะทะฐะฒะตััะตะฝะฝัั ะธะปะธ ะพัะผะตะฝะตะฝะฝัั ะทะฐะบะฐะทะพะฒ ัะฑะธัะฐะตะผ ะบะฝะพะฟะบะธ
            inlineKeyboard = { inline_keyboard: [] };
        }
        
        // ะะฑะฝะพะฒะปัะตะผ ัะพะพะฑัะตะฝะธะต
        await axios.post(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/editMessageText`, {
            chat_id: chatId,
            message_id: messageId,
            text: message,
            parse_mode: 'HTML',
            reply_markup: inlineKeyboard
        });
        
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ัะพะพะฑัะตะฝะธั:', error);
    }
}

// Webhook ะดะปั ะฎKassa
app.post('/api/yookassa/webhook', (req, res) => {
    try {
        const { event, object } = req.body;
        console.log('ะฎKassa webhook received:', { event, object });
        
        if (event === 'payment.succeeded') {
            // ะะปะฐัะตะถ ััะฟะตัะฝะพ ะฟัะพะฒะตะดะตะฝ
            handlePaymentSuccess(object);
        } else if (event === 'payment.canceled') {
            // ะะปะฐัะตะถ ะพัะผะตะฝะตะฝ
            handlePaymentCanceled(object);
        }
        
        res.json({ ok: true });
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ ะฎKassa webhook:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// ะคัะฝะบัะธั ะพะฑัะฐะฑะพัะบะธ ััะฟะตัะฝะพะณะพ ะฟะปะฐัะตะถะฐ
async function handlePaymentSuccess(payment) {
    try {
        const orderId = payment.metadata?.orderId;
        if (!orderId) {
            console.error('ะะต ะฝะฐะนะดะตะฝ orderId ะฒ ะฟะปะฐัะตะถะต');
            return;
        }
        
        const order = getOrder(orderId);
        if (!order) {
            console.error(`ะะฐะบะฐะท ${orderId} ะฝะต ะฝะฐะนะดะตะฝ`);
            return;
        }
        
        // ๐ฅ ะะขะะะะฏะะ ะขะะะะะ ะะะขะะะขะะะะซ
        cancelOrderTimer(orderId);
        
        // ะะฑะฝะพะฒะปัะตะผ ััะฐััั ะทะฐะบะฐะทะฐ ะฝะฐ "ะพะฟะปะฐัะตะฝ"
        order.paymentStatus = 'paid';
        order.paymentId = payment.id;
        order.updatedAt = new Date();
        orders.set(orderId, order);
        
        // ๐พ ะกะะฅะะะะฏะะ ะ ะะกะขะะะะฎ ะะะะฃะะะ
        try {
            await PurchaseHistoryDB.create({
                orderId: order.id,
                userId: order.telegramUserId || order.userId || 'unknown',
                customerName: order.customerName,
                phone: order.phone,
                totalAmount: order.totals?.total || 0,
                itemsCount: order.cartItems?.length || 0,
                items: order.cartItems,
                paymentId: payment.id,
                purchaseDate: new Date(),
                deliveryZone: order.deliveryZone,
                address: order.address
            });
            console.log(`๐พ ะะพะบัะฟะบะฐ ัะพััะฐะฝะตะฝะฐ ะฒ ะธััะพัะธั ะดะปั ะทะฐะบะฐะทะฐ ${orderId}`);
        } catch (error) {
            console.error(`โ ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ะธััะพัะธะธ ะฟะพะบัะฟะบะธ ${orderId}:`, error);
        }
        
        // ๐๏ธ ะะะะะะะฏะะ ะะะะะ ะ ะะ
        try {
            await OrdersDB.update(orderId, order);
            console.log(`๐พ ะะฐะบะฐะท ${orderId} ะพะฑะฝะพะฒะปะตะฝ ะฒ ะะ`);
        } catch (error) {
            console.error(`โ ะัะธะฑะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ะทะฐะบะฐะทะฐ ${orderId} ะฒ ะะ:`, error);
        }
        
        // ๐ฅ ะขะะะะะฌ ะะขะะะะะะฏะะ ะะะะะะ ะฃะะะะะะะะะะ ะ ะะะะะ ะะะฃะะะฃ
        if (TELEGRAM_BOT_TOKEN && TELEGRAM_ADMIN_CHAT_ID) {
            const totalAmount = order.totals?.total || 0;
            const itemsCount = order.cartItems?.length || 0;
            
            const message = `๐ฐ ะะะะะงะะะะซะ ะะะะะ #${orderId}

๐ค ${order.customerName || 'ะะปะธะตะฝั'}
๐ ${order.address.street}, ${order.address.house}${order.address.apartment ? `, ะบะฒ.${order.address.apartment}` : ''} (${order.deliveryZone === 'moscow' ? 'ะะพัะบะฒะฐ' : 'ะะ'})
๐ฐ ${totalAmount}โฝ โ ะะะะะงะะะ
๐ฆ ${itemsCount} ัะพะฒะฐัะพะฒ

๐ ะกะพััะฐะฒ ะทะฐะบะฐะทะฐ:
${order.cartItems.map(item => `โข ${item.name} x${item.quantity} - ${item.price * item.quantity}โฝ`).join('\n')}

๐ฑ ะขะตะปะตัะพะฝ: ${order.phone}
๐ฌ ะะพะผะผะตะฝัะฐัะธะน: ${order.comment || 'ะฝะตั'}

๐ณ ID ะฟะปะฐัะตะถะฐ: ${payment.id}
โฐ ะัะตะผั ะพะฟะปะฐัั: ${new Date().toLocaleString('ru-RU')}

ะะฐะบะฐะท ะณะพัะพะฒ ะบ ะฒัะฟะพะปะฝะตะฝะธั!`;

            // ะกะพะทะดะฐะตะผ ะบะฝะพะฟะบะธ ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะพะฟะปะฐัะตะฝะฝัะผ ะทะฐะบะฐะทะพะผ
            const inlineKeyboard = {
                inline_keyboard: [
                    [
                        { text: '๐ก ะัะธะฝััั', callback_data: `accept_${order.id}` },
                        { text: '๐ต ะะพัะพะฒะธััั', callback_data: `preparing_${order.id}` }
                    ]
                ]
            };
            
            await axios.post(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                chat_id: TELEGRAM_ADMIN_CHAT_ID,
                text: message,
                parse_mode: 'HTML',
                reply_markup: inlineKeyboard
            });
        }
        
        console.log(`โ ะะปะฐัะตะถ ะดะปั ะทะฐะบะฐะทะฐ ${orderId} ะพะฑัะฐะฑะพัะฐะฝ. ะฃะฒะตะดะพะผะปะตะฝะธะต ะพัะฟัะฐะฒะปะตะฝะพ ะฐะดะผะธะฝะฐะผ.`);
        
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ ััะฟะตัะฝะพะณะพ ะฟะปะฐัะตะถะฐ:', error);
    }
}

// ะคัะฝะบัะธั ะพะฑัะฐะฑะพัะบะธ ะพัะผะตะฝะตะฝะฝะพะณะพ ะฟะปะฐัะตะถะฐ
async function handlePaymentCanceled(payment) {
    try {
        const orderId = payment.metadata?.orderId;
        if (!orderId) {
            console.error('ะะต ะฝะฐะนะดะตะฝ orderId ะฒ ะฟะปะฐัะตะถะต');
            return;
        }
        
        const order = getOrder(orderId);
        if (!order) {
            console.error(`ะะฐะบะฐะท ${orderId} ะฝะต ะฝะฐะนะดะตะฝ`);
            return;
        }
        
        // ะะฑะฝะพะฒะปัะตะผ ััะฐััั ะทะฐะบะฐะทะฐ
        order.paymentStatus = 'canceled';
        order.updatedAt = new Date();
        orders.set(orderId, order);
        
        // ะัะฟัะฐะฒะปัะตะผ ัะฒะตะดะพะผะปะตะฝะธะต ะฒ ะฐะดะผะธะฝ-ะณััะฟะฟั
        if (TELEGRAM_BOT_TOKEN && TELEGRAM_ADMIN_CHAT_ID) {
            const message = `โ ะะะะขะะ ะะขะะะะะ!

๐ ะะะะะ #${orderId}
๐ณ ID ะฟะปะฐัะตะถะฐ: ${payment.id}
๐ต ะกัะผะผะฐ: ${payment.amount.value} ${payment.amount.currency}
โ ะกัะฐััั: ะัะผะตะฝะตะฝ

ะะปะธะตะฝั ะพัะผะตะฝะธะป ะพะฟะปะฐัั ะทะฐะบะฐะทะฐ.`;
            
            await axios.post(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                chat_id: TELEGRAM_ADMIN_CHAT_ID,
                text: message,
                parse_mode: 'HTML'
            });
        }
        
        console.log(`ะะปะฐัะตะถ ะดะปั ะทะฐะบะฐะทะฐ ${orderId} ะพัะผะตะฝะตะฝ`);
        
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ ะพัะผะตะฝะตะฝะฝะพะณะพ ะฟะปะฐัะตะถะฐ:', error);
    }
}

// API ะดะปั ัะพะทะดะฐะฝะธั ะฟะปะฐัะตะถะฐ ัะตัะตะท ะฎKassa - ะฃะะะะะ (ะดัะฑะปะธััะตั /api/orders)

// ๐ง MIDDLEWARE ะะะฏ ะะะฉะะขะซ ะะะะะ API
function requireAdminAuth(req, res, next) {
    const providedPassword = req.headers['x-admin-password'] || req.query.password;
    const adminPassword = config.ADMIN_PASSWORD;
    
    if (providedPassword !== adminPassword) {
        return res.status(401).json({ 
            ok: false, 
            error: 'Unauthorized. Admin password required.' 
        });
    }
    
    next();
}

// ๐ง API ะะะฏ ะะกะะะะะะะ ะะะะะะะะะะฏ

// ะะพะปััะตะฝะธะต ัะพะฒะฐัะพะฒ ะดะปั ะพัะฝะพะฒะฝะพะณะพ ะฟัะธะปะพะถะตะฝะธั (ะฟัะฑะปะธัะฝัะน API)
app.get('/api/products', async (req, res) => {
    try {
        // ๐๏ธ ะะะะะฃะะะะ ะะ ะะะะซ ะะะะะซะฅ
        let allProducts = await AdminProductsDB.loadAll();
        
        // ะัะปะธ ะฒ ะะ ะฝะตั ัะพะฒะฐัะพะฒ, ะธัะฟะพะปัะทัะตะผ ะดะฐะฝะฝัะต ะธะท ะฟะฐะผััะธ
        if (Object.keys(allProducts).length === 0 && adminProducts.size > 0) {
            allProducts = Object.fromEntries(adminProducts);
        }
        
        // ะคะธะปััััะตะผ ัะพะปัะบะพ ะดะพัััะฟะฝัะต ัะพะฒะฐัั ะดะปั ะบะปะธะตะฝัะพะฒ
        const productsObj = {};
        for (const [categoryId, categoryProducts] of Object.entries(allProducts)) {
            const availableProducts = categoryProducts.filter(product => product.available !== false);
            if (availableProducts.length > 0) {
                productsObj[categoryId] = availableProducts;
            }
        }
        
        res.json({ ok: true, products: productsObj });
        
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ัะพะฒะฐัะพะฒ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// ๐ง API ะะะฏ ะะะะะ ะะะะะะ

// ะะพะปััะตะฝะธะต ะฒัะตั ัะพะฒะฐัะพะฒ ะดะปั ะฐะดะผะธะฝ ะฟะฐะฝะตะปะธ
app.get('/api/admin/products', requireAdminAuth, async (req, res) => {
    try {
        // ๐๏ธ ะะะะะฃะะะะ ะะ ะะะะซ ะะะะะซะฅ
        let products = await AdminProductsDB.loadAll();
        
        // ๐ ะะะะฆะะะะะะะฆะะฏ ะขะะะฌะะ ะะกะะ ะะ ะะะะะะกะขะฌะฎ ะะฃะกะขะ (ะะะะะซะ ะะะะฃะกะ)
        if (Object.keys(products).length === 0) {
            console.log('๐ ะะ ะฟัััะฐ, ะธะฝะธัะธะฐะปะธะทะธััะตะผ ะฟะพะปะฝัะผ ะฐััะพััะธะผะตะฝัะพะผ ัะพะฒะฐัะพะฒ...');
            
            // ะะพะปะฝัะน ะฐััะพััะธะผะตะฝั ัะพะฒะฐัะพะฒ (ะฒัะต 49 ัะพะฒะฐัะพะฒ)
            const fullProducts = await loadFullProductCatalog();
            
            // ะกะพััะฐะฝัะตะผ ะฒ ะะ ะขะะะฌะะ ะะะะ ะะะ
            try {
                await AdminProductsDB.saveAll(fullProducts);
                console.log('โ ะะพะปะฝัะน ะบะฐัะฐะปะพะณ ัะพะฒะฐัะพะฒ ัะพััะฐะฝะตะฝ ะฒ ะะ ะะะะะซะ ะะะ');
                products = fullProducts;
                
                // ะะฐะฟะพะปะฝัะตะผ ะปะพะบะฐะปัะฝัะน ะบัั
                Object.entries(fullProducts).forEach(([categoryId, categoryProducts]) => {
                    adminProducts.set(categoryId, categoryProducts);
                });
            } catch (error) {
                console.error('โ ะัะธะฑะบะฐ ัะพััะฐะฝะตะฝะธั ะฟะพะปะฝะพะณะพ ะบะฐัะฐะปะพะณะฐ:', error);
                products = fullProducts; // ะัะฟะพะปัะทัะตะผ ะบะฐะบ fallback
            }
        } else {
            // โ ะะกะะะะฌะะฃะะ ะกะะฅะะะะะะะซะ ะะะะะซะ ะะ ะะ (ั ะธะทะผะตะฝะตะฝะธัะผะธ ะฟะพะปัะทะพะฒะฐัะตะปั)
            console.log('โ ะะฐะณััะถะตะฝั ัะพััะฐะฝะตะฝะฝัะต ัะพะฒะฐัั ะธะท ะะ ั ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะผะธ ะธะทะผะตะฝะตะฝะธัะผะธ');
        }
        
        res.json({ ok: true, products });
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ัะพะฒะฐัะพะฒ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// ะะฑะฝะพะฒะปะตะฝะธะต ัะพะฒะฐัะพะฒ ัะตัะตะท ะฐะดะผะธะฝ ะฟะฐะฝะตะปั
app.put('/api/admin/products', requireAdminAuth, async (req, res) => {
    try {
        const { products } = req.body;
        
        // ๐๏ธ ะกะะฅะะะะฏะะ ะ ะะะะฃ ะะะะะซะฅ
        await AdminProductsDB.saveAll(products);
        
        // ะะฑะฝะพะฒะปัะตะผ ะปะพะบะฐะปัะฝัะน ะบัั ะดะปั ัะพะฒะผะตััะธะผะพััะธ
        adminProducts.clear();
        Object.entries(products).forEach(([categoryId, categoryProducts]) => {
            adminProducts.set(categoryId, categoryProducts);
        });
        
        console.log('๐ง ะขะพะฒะฐัั ะพะฑะฝะพะฒะปะตะฝั ัะตัะตะท ะฐะดะผะธะฝ ะฟะฐะฝะตะปั ะธ ัะพััะฐะฝะตะฝั ะฒ ะะ');
        res.json({ ok: true, message: 'ะขะพะฒะฐัั ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝั ะธ ัะพััะฐะฝะตะฝั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั' });
        
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ัะพะฒะฐัะพะฒ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// ะะตัะตะบะปััะตะฝะธะต ะดะพัััะฟะฝะพััะธ ัะพะฒะฐัะฐ
app.patch('/api/admin/products/:categoryId/:productId/toggle', requireAdminAuth, async (req, res) => {
    try {
        const { categoryId, productId } = req.params;
        
        // ๐๏ธ ะะะะะฃะะะะ ะะกะ ะขะะะะะซ ะะ ะะ
        let allProducts = await AdminProductsDB.loadAll();
        
        // ะัะปะธ ะฒ ะะ ะฟัััะพ, ะธัะฟะพะปัะทัะตะผ ะฟะฐะผััั
        if (Object.keys(allProducts).length === 0) {
            allProducts = Object.fromEntries(adminProducts);
        }
        
        const categoryProducts = allProducts[categoryId];
        if (!categoryProducts) {
            return res.status(404).json({ ok: false, error: 'ะะฐัะตะณะพัะธั ะฝะต ะฝะฐะนะดะตะฝะฐ' });
        }
        
        const product = categoryProducts.find(p => p.id === productId);
        if (!product) {
            return res.status(404).json({ ok: false, error: 'ะขะพะฒะฐั ะฝะต ะฝะฐะนะดะตะฝ' });
        }
        
        // ะะตัะตะบะปััะฐะตะผ ะดะพัััะฟะฝะพััั
        product.available = !product.available;
        
        // ๐พ ะกะะฅะะะะฏะะ ะะกะ ะขะะะะะซ ะะะะะขะะ ะ ะะ
        await AdminProductsDB.saveAll(allProducts);
        
        // ะะฑะฝะพะฒะปัะตะผ ะปะพะบะฐะปัะฝัะน ะบัั
        if (adminProducts.has(categoryId)) {
            const localProducts = adminProducts.get(categoryId);
            const localProduct = localProducts.find(p => p.id === productId);
            if (localProduct) {
                localProduct.available = product.available;
            }
        }
        
        console.log(`๐ง ะขะพะฒะฐั ${productId} ${product.available ? 'ะฟะพะบะฐะทะฐะฝ' : 'ัะบััั'} ะธ ัะพััะฐะฝะตะฝ ะฒ ะะ`);
        res.json({ ok: true, product, available: product.available });
        
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะฟะตัะตะบะปััะตะฝะธั ัะพะฒะฐัะฐ:', error);
        res.status(500).json({ ok: false, error: error.message });
    }
});

// SPA fallback - ะฒัะต ะพััะฐะปัะฝัะต ะผะฐัััััั ะฒะตะดัั ะฝะฐ index.html
app.get(/^\/(?!api).*/, (req, res) => {
    const requestedPath = req.path;
    
    // ะัะปะธ ะทะฐะฟัะฐัะธะฒะฐะตััั admin.html, ะฟัะพะฒะตััะตะผ ะฟะฐัะพะปั
    if (requestedPath === '/admin' || requestedPath === '/admin.html') {
        const adminPassword = config.ADMIN_PASSWORD;
        const providedPassword = req.query.password;
        
        if (providedPassword !== adminPassword) {
            res.status(401).send(`
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ะัะพะด ะฒ ะฐะดะผะธะฝ ะฟะฐะฝะตะปั</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0b5c56, #2C5530);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .login-container {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .login-icon { font-size: 60px; margin-bottom: 20px; }
        .login-title { font-size: 28px; font-weight: 700; margin-bottom: 10px; }
        .login-subtitle { opacity: 0.9; margin-bottom: 30px; }
        .login-form { margin-top: 30px; }
        .login-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
        }
        .login-btn {
            width: 100%;
            background: #D4A574;
            color: #1A1F2E;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .login-btn:hover { background: #c19660; transform: translateY(-2px); }
        .error-msg {
            background: rgba(231, 76, 60, 0.2);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-icon">๐</div>
        <div class="login-title">ะะดะผะธะฝ ะฟะฐะฝะตะปั</div>
        <div class="login-subtitle">Tundra Gourmet</div>
        
        ${providedPassword ? '<div class="error-msg">โ ะะตะฒะตัะฝัะน ะฟะฐัะพะปั</div>' : ''}
        
        <form class="login-form" method="GET">
            <input type="password" 
                   name="password" 
                   class="login-input" 
                   placeholder="ะะฒะตะดะธัะต ะฟะฐัะพะปั" 
                   required 
                   autofocus>
            <button type="submit" class="login-btn">๐ ะะพะนัะธ</button>
        </form>
        
        <div style="margin-top: 30px; font-size: 14px; opacity: 0.7;">
            ๐ก ะัะปะธ ะทะฐะฑัะปะธ ะฟะฐัะพะปั, ะพะฑัะฐัะธัะตัั ะบ ัะฐะทัะฐะฑะพััะธะบั
        </div>
    </div>
</body>
</html>
            `);
            return;
        }
        
        res.sendFile(path.join(webRoot, 'admin.html'));
        return;
    }
    
    // ะััะฐะปัะฝัะต ะผะฐัััััั ะฒะตะดัั ะฝะฐ ะพัะฝะพะฒะฝะพะต ะฟัะธะปะพะถะตะฝะธะต
    res.sendFile(path.join(webRoot, 'index.html'));
});

// ะะฐะฟััะบ ัะตัะฒะตัะฐ ั ะธะฝะธัะธะฐะปะธะทะฐัะธะตะน ะะ
async function startServer() {
    try {
        // ๐๏ธ ะะะะะฃะะะขะะะฌะะะฏ ะะงะะกะขะะ ะะ (ะตัะปะธ ัััะฐะฝะพะฒะปะตะฝะฐ ะฟะตัะตะผะตะฝะฝะฐั)
        if (process.env.CLEAR_DATABASE === 'true') {
            console.log('๐จ ะะะะะฃะะะขะะะฌะะะฏ ะะงะะกะขะะ ะะะะซ ะะะะะซะฅ...');
            try {
                const { Pool } = require('pg');
                const pool = new Pool({ connectionString: config.DATABASE_URL });
                await pool.query('DELETE FROM admin_products');
                await pool.end();
                console.log('โ ะขะฐะฑะปะธัะฐ admin_products ะพัะธัะตะฝะฐ');
            } catch (error) {
                console.error('โ ะัะธะฑะบะฐ ะพัะธััะบะธ ะะ:', error);
            }
        }
        
        // ะะฝะธัะธะฐะปะธะทะธััะตะผ ะฑะฐะทั ะดะฐะฝะฝัั
        await initializeDatabase();
        
        // ะะฐะณััะถะฐะตะผ ัะพะฒะฐัั ะธะท ะะ ะตัะปะธ ะตััั
        try {
            const dbProducts = await AdminProductsDB.loadAll();
            if (Object.keys(dbProducts).length > 0) {
                console.log('โ ะขะพะฒะฐัั ะทะฐะณััะถะตะฝั ะธะท ะฑะฐะทั ะดะฐะฝะฝัั');
                // ะัะตะพะฑัะฐะทัะตะผ ะฒ Map ะดะปั ัะพะฒะผะตััะธะผะพััะธ ั ัะตะบััะธะผ ะบะพะดะพะผ
                adminProducts.clear();
                for (const [categoryId, products] of Object.entries(dbProducts)) {
                    adminProducts.set(categoryId, products);
                }
            }
        } catch (error) {
            console.log('โ๏ธ ะขะพะฒะฐัั ะธะท ะะ ะฝะต ะทะฐะณััะถะตะฝั, ะธัะฟะพะปัะทัะตะผ fallback');
        }
        
        // ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั
        app.listen(PORT, () => {
            console.log(`๐ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั ${PORT}`);
            console.log(`๐ ะกัะฐัะธัะตัะบะธะต ัะฐะนะปั ะธะท: ${webRoot}`);
            console.log(`๐ Health check: http://localhost:${PORT}/health`);
            console.log(`๐๏ธ ะะฐะทะฐ ะดะฐะฝะฝัั ะฟะพะดะบะปััะตะฝะฐ`);
        });
        
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ:', error);
        process.exit(1);
    }
}

// ๐ก๏ธ ะะะะะะะขะะ ะะะะะะะฅะะะงะะะะซะฅ ะะจะะะะ
process.on('uncaughtException', (error) => {
    console.error('๐ฅ ะะตะฟะตัะตัะฒะฐัะตะฝะฝะฐั ะพัะธะฑะบะฐ:', error);
    console.error('Stack:', error.stack);
    // ะะ ะทะฐะฒะตััะฐะตะผ ะฟัะพัะตัั, ะปะพะณะธััะตะผ ะธ ะฟัะพะดะพะปะถะฐะตะผ
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('๐ฅ ะะตะฟะตัะตัะฒะฐัะตะฝะฝะพะต ะพัะบะปะพะฝะตะฝะธะต ะฟัะพะผะธัะฐ:', reason);
    console.error('ะัะพะผะธั:', promise);
    // ะะ ะทะฐะฒะตััะฐะตะผ ะฟัะพัะตัั, ะปะพะณะธััะตะผ ะธ ะฟัะพะดะพะปะถะฐะตะผ
});

startServer();

// Keep-alive ะผะตัะฐะฝะธะทะผ ะดะปั Railway
setInterval(() => {
    const uptime = process.uptime();
    const memory = process.memoryUsage();
    console.log(`๐ Keep-alive ping: ${new Date().toISOString()}, Uptime: ${Math.floor(uptime)}s, Memory: ${Math.round(memory.heapUsed / 1024 / 1024)}MB`);
}, 5 * 60 * 1000); // ะะฐะถะดัะต 5 ะผะธะฝัั

// Graceful shutdown ั ะพัะธััะบะพะน ัะตััััะพะฒ
process.on('SIGTERM', () => {
    console.log('๐ ะะพะปััะตะฝ ัะธะณะฝะฐะป SIGTERM, ะทะฐะฒะตััะฐะตะผ ัะฐะฑะพัั...');
    cleanup();
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('๐ ะะพะปััะตะฝ ัะธะณะฝะฐะป SIGINT, ะทะฐะฒะตััะฐะตะผ ัะฐะฑะพัั...');
    cleanup();
    process.exit(0);
});

// ะคัะฝะบัะธั ะพัะธััะบะธ ัะตััััะพะฒ
function cleanup() {
    console.log('๐งน ะัะธััะบะฐ ัะตััััะพะฒ...');
    
    // ะัะธัะฐะตะผ ะฒัะต ัะฐะนะผะตัั ะทะฐะบะฐะทะพะฒ
    for (const [orderId, timer] of orderTimers.entries()) {
        clearTimeout(timer);
        console.log(`๐๏ธ ะขะฐะนะผะตั ะทะฐะบะฐะทะฐ ${orderId} ะพัะธัะตะฝ`);
    }
    orderTimers.clear();
    
    console.log('โ ะะตััััั ะพัะธัะตะฝั');
}
